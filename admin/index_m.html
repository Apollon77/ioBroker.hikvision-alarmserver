<html>
  <head>
    <!-- Load ioBroker scripts and styles-->
    <link rel="stylesheet" type="text/css" href="../../css/adapter.css" />
    <link
      rel="stylesheet"
      type="text/css"
      href="../../lib/css/materialize.css"
    />

    <script
      type="text/javascript"
      src="../../lib/js/jquery-3.2.1.min.js"
    ></script>
    <script type="text/javascript" src="../../socket.io/socket.io.js"></script>

    <script type="text/javascript" src="../../js/translate.js"></script>
    <script type="text/javascript" src="../../lib/js/materialize.js"></script>
    <script type="text/javascript" src="../../js/adapter-settings.js"></script>

    <!-- Load our own files -->
    <link rel="stylesheet" type="text/css" href="style.css" />
    <script type="text/javascript" src="words.js"></script>

    <script type="text/javascript">
      // This will be called by the admin adapter when the settings page loads
      function load(settings, onChange) {
        if (!settings) return;
        $(".value").each(function () {
          var $key = $(this);
          var id = $key.attr("id");
          if ($key.attr("type") === "checkbox") {
            // do not call onChange direct, because onChange could expect some arguments
            $key.prop("checked", settings[id]).on("change", () => onChange());
          } else {
            // do not call onChange direct, because onChange could expect some arguments
            $key
              .val(settings[id])
              .on("change", () => onChange())
              .on("keyup", () => onChange());
          }
        });
        getIPs(function (ips) {
          for (var lp = 0; lp < ips.length; lp++) {
            $("#bind").append(
              '<option value="' +
                ips[lp].address +
                '">' +
                ips[lp].name +
                "</option>"
            );
          }
          $("#bind.value")
            .val(settings.bind ? settings.bind : "0.0.0.0")
            .select();
        });
        onChange(false);
        // reinitialize all the Materialize labels on the page if you are dynamically adding inputs:
        if (M) M.updateTextFields();
      }

      // This will be called by the admin adapter when the user presses the save button
      function save(callback) {
        var obj = {};
        $(".value").each(function () {
          var $this = $(this);
          if ($this.attr("type") === "checkbox") {
            obj[$this.attr("id")] = $this.prop("checked");
          } else if ($this.attr("type") === "number") {
            obj[$this.attr("id")] = parseFloat($this.val());
          } else {
            obj[$this.attr("id")] = $this.val();
          }
        });
        callback(obj);
      }
    </script>
  </head>

  <body>
    <div class="m adapter-container">
      <div class="col s12">
        <ul class="tabs">
          <li class="tab col s2">
            <a href="#tab-main" class="translate active">Main settings</a>
          </li>
          <li class="tab col s2 channels">
            <a href="#tab-channels" class="translate">Channels</a>
          </li>
          <li class="tab col s2 send">
            <a href="#tab-send" class="translate">Sending</a>
          </li>
          <li class="tab col s2 save">
            <a href="#tab-save" class="translate">Saving</a>
          </li>
          <li class="tab col s2 processing">
            <a href="#tab-processing" class="translate">Processing</a>
          </li>
        </ul>
      </div>

      <div id="tab-main">
        <div class="row">
          <div class="col s12 m4 l2">
            <img src="hikvision-alarmserver.png" class="logo" />
          </div>
        </div>

        <div class="row">
          <div class="col s12 m4 12 input-field">
            <input type="text" class="value" id="port" />
            <label for="port" class="translate">Listen port</label>
          </div>
          <div class="input-field col s12 m8 12" id="_bind">
            <select class="value" id="bind"></select>
            <label class="translate" for="bind">Listen address</label>
          </div>
        </div>

        <div class="row">
          <div class="col s12 input-field">
            <input type="number" class="value" id="alarmTimeout" />
            <label for="alarmTimeout" class="translate">
              Alarm timeout (ms)
            </label>
            <br />
            <span class="translate">
              Time (in milliseconds) after no message reception that an alarm is
              cleared.
            </span>
          </div>
        </div>
      </div>

      <div id="tab-channels">
        <div class="row">
          <div class="col s12 input-field">
            <input type="checkbox" class="value" id="useChannels" />
            <span class="translate">
              Create camera channels below devices
            </span>
            <br />
            <span class="translate">
              Can be useful for devices that have more than one sensor.
            </span>
          </div>
        </div>
        <div class="row">
          <div class="col s12 input-field">
            <input type="checkbox" class="value" id="useDetectionTargets" />
            <span class="translate">
              Create camera detection target channels below devices
            </span>
            <br />
            <span class="translate">
              Can be useful for smart devices that classify motion targets (eg.
              'human', 'vehicle', etc').
            </span>
          </div>
        </div>
      </div>

      <div id="tab-send">
        <div class="row">
          <div class="col s12 translate">
            It is possible to use ioBroker's <i>sendTo</i> functionality to send
            event XML and/or images to to other adapters (eg. Telegram, email,
            pushsafer, etc).
          </div>
          <div class="col s12 translate">
            This is only applies to complex (multipart) message types.
          </div>
        </div>
        <div class="row">
          <div class="col s12 input-field">
            <input type="text" class="value" id="sendToInstanceName" />
            <label for="sendToInstanceName" class="translate">
              Send to instance name
            </label>
            <span>Leave this blank to disable sendTo functionality.</span>
          </div>
        </div>
        <div class="row">
          <div class="col s12 input-field">
            <input type="text" class="value" id="sendToCommand" />
            <label for="sendToCommand" class="translate">
              Send to command
            </label>
          </div>
        </div>
        <div class="row">
          <div class="col s12 input-field">
            <input type="text" class="value" id="sendToMessage" />
            <label for="sendToMessage" class="translate">
              Send to message
            </label>
            <br />
            <span class="translate">
              JS code to construct the message object to send.<br />
              Eg. to send images to Telegram use,
              <i>{ text: imageBuffer, type: 'photo' }</i>.<br />
              For available variables are <i>imageBuffer</i> and
              <i>ctx</i> (event context).
            </span>
          </div>
        </div>

        <div class="row">
          <div class="col s12 input-field">
            <input type="number" class="value" id="sendToThrottle" />
            <label for="sendToThrottle" class="translate">
              send to throttle (ms)
            </label>
            <br />
            <span class="translate">
              Skip sending unless at least this time has elapsed since last
              message (time in milliseconds).<br />
              Set to zero to disable.
            </span>
          </div>
        </div>

        <div class="row">
          <div class="col input-field">
            <input type="checkbox" class="value" id="sendToThrottleByDevice" />
            <span class="translate"> Throttle is on a per-device basis </span>
            <br />
            <span class="translate">
              Uncheck to make minimum delay between sending a global condition
              (ie. irrespective of source device).
            </span>
          </div>
        </div>
      </div>

      <div id="tab-save">
        <div class="row">
          <div class="col s12 translate">
            It is possible to save event XML and/or images (to the iobroker-data
            dirctory) for further processing/analysis/archiving/etc.
          </div>
          <div class="col s12 translate">
            This is only applies to complex (multipart) message types.
          </div>
        </div>
        <div class="row">
          <div class="col s12 input-field">
            <input type="checkbox" class="value" id="saveXml" />
            <span class="translate">Save event XML</span>
          </div>
        </div>
        <div class="row">
          <div class="col s12 input-field">
            <input type="checkbox" class="value" id="saveImages" />
            <span class="translate">Save event images</span>
          </div>
        </div>
      </div>

      <div id="tab-processing">
        <div class="row">
          <div class="col s12 translate">
            Perform the following processing on XML/images before saving and/or
            sending.
          </div>
          <div class="col s12 translate">
            This is only applies to complex (multipart) message types.
          </div>
        </div>
        <div class="row">
          <div class="col s12 input-field">
            <input type="checkbox" class="value" id="annotateImages" />
            <span class="translate">Annotate images</span>
            <br />
            <span class="translate">
              Draws region box and labels detected targets.
            </span>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
